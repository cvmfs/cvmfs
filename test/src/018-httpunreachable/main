
cvmfs_test_name="HTTP Server Unreachable"

do_faulty_mount() {
  cvmfs_mount "atlas.cern.ch"          \
              "CVMFS_TIMEOUT=3"        \
              "CVMFS_TIMEOUT_DIRECT=3" \
              "CVMFS_HTTP_PROXY=DIRECT"
}

cvmfs_run_test() {
  logfile=$1
  local scratch_dir=$(pwd)
  local retcode=0
  local seconds=100

  echo "configure cvmfs with a number of unreachable hosts" >> $logfile
  sudo sh -c "echo \"CVMFS_SERVER_URL=\\\"http://127.0.0.1:80;http://127.0.0.2:8080;http://cvmfs-stratum-one.cern.ch/opt/@org@\\\"\" > /etc/cvmfs/domain.d/cern.ch.local" || return 1

  echo "try to mount cvmfs" >> $logfile
  seconds=$(stop_watch do_faulty_mount)
  rm -f /etc/cvmfs/domain.d/cern.ch.local

  echo "try to list the repository" >> $logfile
  ls /cvmfs/atlas.cern.ch >> $logfile 2>&1 || return 2

  if [ $seconds -gt 8 ]; then
    echo "mounting took too long with $seconds seconds (expected 8)" >> $logfile
    return 1
  fi
}
