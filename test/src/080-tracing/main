cvmfs_test_name="tracing"

cvmfs_run_test() {
    logfile=$1
    sudo sh -c "echo \"export GLITE_VERSION='util'\" > /etc/cvmfs/config.d/grid.cern.ch.local"
    repo="grid.cern.ch"
    echo "Setup..."
    rm -f /tmp/cvmfs-$repo.trace.log 2> /dev/null
    echo "Mounting test repository..."
    cvmfs_mount $repo "CVMFS_TRACEFILE=/tmp/cvmfs-@fqrn@.trace.log" "CVMFS_TRACEBUFFER=4096" "CVMFS_TRACEBUFFER_THRESHOLD=2048" > /dev/null

    echo "Checking trace log creation..."
    sudo cvmfs_talk tracebuffer flush > /dev/null

    if [ ! -f /tmp/cvmfs-$repo.trace.log ]; then
        echo "ERROR: Log file was not created"
        return 2
    fi

    cp /dev/null /tmp/cvmfs-$repo.trace.log > /dev/null

    echo "Executing a few operations to check tracing..."

    ls /cvmfs/$repo/ > /dev/null
    ls /cvmfs/$repo/vc/bin > /dev/null
    cat /cvmfs/$repo/README > /dev/null
    df -P /cvmfs/$repo/README > /dev/null
    getfattr -d -m ".*" /cvmfs/$repo/README > /dev/null
    ls /cvmfs/$repo/glite > /dev/null

    sudo cvmfs_talk tracebuffer flush > /dev/null

    if ! (check_trace 2 opendir ""\
        && check_trace 6 getattr ""\
        && check_trace 4 lookup "/vc"\
        && check_trace 4 lookup "/vc/bin"\
        && check_trace 2 opendir "/vc/bin"\
        && check_trace 4 lookup "/README"\
        && check_trace 1 open "/README"\
        && check_trace 6 getattr "/README"\
        && check_trace 5 statfs "/README"\
        && check_trace 7 listxattr "/README"\
        && check_trace 6 getxattr "/README"\
        && check_trace 4 lookup "/glite"\
        && check_trace 3 readlink "/glite"\
        && check_trace 4 lookup "/util"\
        && check_trace 2 opendir "/util"\

        ); then 
            return 3
    fi
    
    return 0
}

check_trace() {
    if ! grep -q "\"$1\",\"$3\",\"$2()\"" /tmp/cvmfs-$repo.trace.log; then
        echo "Log did not trace $2 of $3"
        return 3
    fi
}
# Expected:
# opendir /
# getattr /

# lookup /vc
# lookup /vc/bin
# opendir /vc/bin
# getattr /vc/bin

# lookup /README
# open /README
# getattr /README
# open /README
# statfs /README

# listxattr /README
# getxattr /README [...]

# lookup /glite
# readlink /$(GLITE_VERSION)
# lookup /util
# opendir /util

