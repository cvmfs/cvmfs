cvmfs_test_name="shrinkwrap"

cleanup() {
    sudo rm -f /tmp/cvmfs-$repo.trace.log 2> /dev/null
    sudo rm -f /tmp/cvmfs-$repo.spec.txt  2> /dev/null
    sudo rm -f /tmp/posix_dir  2> /dev/null
    sudo rm -f /tmp/posix_data  2> /dev/null
}

cvmfs_run_test() {
    logfile=$1
    local repo="test.cern.ch"
    echo "*** Setup..."
    cleanup
    trap cleanup HUP EXIT TERM INT || return 4
    echo "*** Mounting test repository..."
    cvmfs_mount $repo "GLITE_VERSION=util" "CVMFS_TRACEFILE=/tmp/cvmfs-@fqrn@.trace.log" "CVMFS_TRACEBUFFER=4096" "CVMFS_TRACEBUFFER_THRESHOLD=2048" > /dev/null

    echo "Checking trace log creation..."
    sudo cvmfs_talk -i $repo tracebuffer flush > /dev/null

    if [ ! -f /tmp/cvmfs-$repo.trace.log ]; then
        echo "*** ERROR: Log file was not created"
        return 2
    fi

    sudo truncate -s0 /tmp/cvmfs-$repo.trace.log > /dev/null

    echo "*** Executing a few operations to check tracing..."

    ls /cvmfs/$repo/
    cat /cvmfs/$repo/test.txt
    df -P /cvmfs/$repo/test.txt

    sudo cvmfs_talk -i $repo tracebuffer flush > /dev/null

    sudo python $TEST_ROOT/../python/spec_builder.py /tmp/cvmfs-$repo.trace.log /tmp/cvmfs-$repo.spec.txt

    # sudo cvmfs_config showconfig -s $repo > /tmp/$repo.config

    sudo cvmfs_shrinkwrap -r $repo -f /tmp/$repo.config -t /tmp/cvmfs-$repo.spec.txt -x /tmp/posix_dir  2> $logfile.dbg

    return 0
}

