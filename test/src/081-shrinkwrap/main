cvmfs_test_name="tracing"

cleanup() {
    sudo rm -f /tmp/cvmfs-$repo.trace.log 2> /dev/null
}

cvmfs_run_test() {
    logfile=$1
    local repo="test.cern.ch"
    echo "*** Setup..."
    cleanup
    trap cleanup HUP EXIT TERM INT || return 4
    echo "*** Mounting test repository..."
    cvmfs_mount $repo "GLITE_VERSION=util" "CVMFS_TRACEFILE=/tmp/cvmfs-@fqrn@.trace.log" "CVMFS_TRACEBUFFER=4096" "CVMFS_TRACEBUFFER_THRESHOLD=2048" > /dev/null

    echo "Checking trace log creation..."
    sudo cvmfs_talk -i $repo tracebuffer flush > /dev/null

    if [ ! -f /tmp/cvmfs-$repo.trace.log ]; then
        echo "*** ERROR: Log file was not created"
        return 2
    fi

    sudo truncate -s0 /tmp/cvmfs-$repo.trace.log > /dev/null

    echo "*** Executing a few operations to check tracing..."

    ls /cvmfs/$repo/
    cat /cvmfs/$repo/README
    df -P /cvmfs/$repo/README
    list_xattrs /cvmfs/$repo/README
    #getfattr -d -m ".*" /cvmfs/$repo/README

    sudo cvmfs_talk -i $repo tracebuffer flush > /dev/null

    
    sudo python $TEST_ROOT/../python/spec_builder.py /tmp/cvmfs-$repo.trace.log /tmp/cvmfs-$repo.spec.txt

    return 0
}

check_trace() {
    if ! sudo grep -q "\"$1\",\"$3\",\"$2()\"" /tmp/cvmfs-$repo.trace.log; then
        echo "*** Log did not trace $2 of $3"
        return 3
    fi
}
