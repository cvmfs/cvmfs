
cvmfs_test_name="Test CVMFS over HTTPS"
cvmfs_test_autofs_on_startup=false

TEST600_HTTPS_CONFIG=/etc/httpd/conf.d/test600.cvmfs.secure.conf
TEST600_HOSTCERT=/etc/grid-security/hostcert-cvmfs.pem
TEST600_HOSTKEY=/etc/grid-security/hostkey-cvmfs.pem
TEST600_VOMSDIR=/etc/grid-security/vomsdir/cvmfs
TEST600_TESTCA=/etc/grid-security/certificates/OSG-Test-CA.pem
TEST600_TESTCRL=/etc/grid-security/certificates/OSG-Test-CA.r0
# These two variables will be updated later with the generated hash
TEST600_TESTCA_HASH=/etc/grid-security/certificates/OSG-Test-CA.pem
TEST600_TESTCRL_HASH=/etc/grid-security/certificates/OSG-Test-CA.r0

cleanup() {
  [ -z "$TEST600_HTTPS_CONFIG" ] || sudo rm -f $TEST600_HTTPS_CONFIG
  [ -z "$TEST600_HOSTCERT" ] || sudo rm -f $TEST600_HOSTCERT
  [ -z "$TEST600_HOSTKEY" ] || sudo rm -f $TEST600_HOSTKEY
  [ -z "$TEST600_VOMSDIR" ] || sudo rm -fR $TEST600_VOMSDIR
  [ -z "$TEST600_TESTCA" ] || sudo rm -f $TEST600_TESTCA
  [ -z "$TEST600_TESTCRL" ] || sudo rm -f $TEST600_TESTCRL
  [ -z "$TEST600_TESTCA_HASH" ] || sudo rm -f $TEST600_TESTCA_HASH
  [ -z "$TEST600_TESTCRL_HASH" ] || sudo rm -f $TEST600_TESTCRL_HASH
}

generate_certs() {
  local certs_dir=$(pwd)/certs
  local script_location=$1
  mkdir $certs_dir
  cp $script_location/ca-generate-certs $certs_dir/
  cp $script_location/openssl-usercert-extensions.conf $certs_dir/
  cp $script_location/openssl-cert-extensions-template.conf $certs_dir/
  cp $script_location/openssl.config $certs_dir/

  pushd $certs_dir
  ./ca-generate-certs $HOSTNAME
  result=$?
  voms-proxy-fake -cert usercert.pem -key userkey.pem -out vomsproxy.pem -rfc -hostcert hostcert.pem -hostkey hostkey.pem -fqan /cvmfs/Role=NULL -voms cvmfs -uri $HOSTNAME:15000
  popd

  mkdir -p /etc/grid-security/vomsdir/cvmfs

  set -x
  echo "/DC=org/DC=Open Science Grid/O=OSG Test/OU=Services/CN=$HOSTNAME" > /etc/grid-security/vomsdir/cvmfs/$HOSTNAME.lsc
  echo "/DC=org/DC=Open Science Grid/O=OSG Test/CN=OSG Test CA" >> /etc/grid-security/vomsdir/cvmfs/$HOSTNAME.lsc

  voms-proxy-info -file $certs_dir/vomsproxy.pem -all

  sudo cp $certs_dir/hostcert.pem $TEST600_HOSTCERT || return 1
  sudo cp $certs_dir/hostkey.pem $TEST600_HOSTKEY || return 1
  sudo cp $certs_dir/OSG-Test-CA.pem $TEST600_TESTCA || return 1
  sudo cp $certs_dir/OSG-Test-CA.r0 $TEST600_TESTCRL || return 1
  local hash=`openssl x509 -in $TEST600_TESTCA -noout -hash`
  TEST600_TESTCA_HASH=/etc/grid-security/certificates/${hash}.0
  TEST600_TESTCRL_HASH=/etc/grid-security/certificates/${hash}.r0
  sudo ln -sf $TEST600_TESTCA $TEST600_TESTCA_HASH || return 1
  sudo ln -sf $TEST600_TESTCRL $TEST600_TESTCRL_HASH || return 1
  set +x

  return $result;
}

cvmfs_run_test() {
  local logfile=$1
  local script_location=$2
  local scratch_dir=$(pwd)

  # Generate repo first - check will fail after apache change below until we
  # change the default URL.
  [ -z "$TEST600_HTTPS_CONFIG" ] || sudo rm -f $TEST600_HTTPS_CONFIG
  echo "restarting apache"
  apache_switch off
  apache_switch on

  echo "create a fresh repository named $CVMFS_TEST_REPO with user $CVMFS_TEST_USER"
  create_empty_repo $CVMFS_TEST_REPO $CVMFS_TEST_USER NO -V /cvmfs || return $?

  start_transaction $CVMFS_TEST_REPO || return $?
  echo "Hello World" > /cvmfs/$CVMFS_TEST_REPO/hello_world
  publish_repo $CVMFS_TEST_REPO -v || return $?

  # ( . ${script_location}/../../common/migration_tests/common.sh; install_packages gridsite voms-clients-cpp )

  echo "set a trap for system directory cleanup"
  #trap cleanup EXIT HUP INT TERM

  generate_certs $script_location
  cp $script_location/test600.cvmfs.secure.conf $TEST600_HTTPS_CONFIG
  sed -i "s/@REPONAME@/$CVMFS_TEST_REPO/" $TEST600_HTTPS_CONFIG
  cp $script_location/gacl /srv/cvmfs/$CVMFS_TEST_REPO/data/.gacl
  echo "restarting apache"
  apache_switch off
  apache_switch on

  sed -i "s|CVMFS_SERVER_URL=http://localhost/cvmfs/$CVMFS_TEST_REPO|CVMFS_SERVER_URL=https://$HOSTNAME:8443/cvmfs/$CVMFS_TEST_REPO|" /etc/cvmfs/repositories.d/$CVMFS_TEST_REPO/client.conf
  umount /cvmfs/$CVMFS_TEST_REPO
  umount /var/spool/cvmfs/$CVMFS_TEST_REPO/rdonly
  # Remove any cached files to make sure we reload over https.
  rm -rf /var/spool/cvmfs/$CVMFS_TEST_REPO/cache/$CVMFS_TEST_REPO
  cvmfs2 $CVMFS_TEST_REPO /var/spool/cvmfs/$CVMFS_TEST_REPO/rdonly -o rw,allow_other,config=/etc/cvmfs/repositories.d/$CVMFS_TEST_REPO/client.conf,cvmfs_suid,dev,suid || return $?
  mount /cvmfs/$CVMFS_TEST_REPO
  export X509_USER_PROXY=$(pwd)/certs/vomsproxy.pem
  cp $(pwd)/certs/vomsproxy.pem $(pwd)/certs/vomsproxy.pem.nobody
  chown nobody: $(pwd)/certs/vomsproxy.pem.nobody
  cat $X509_USER_PROXY
  sudo -u nobody /bin/sh -c "X509_USER_PROXY=$PWD/certs/vomsproxy.pem.nobody cat /cvmfs/$CVMFS_TEST_REPO/hello_world" > /dev/null || return $?
  # This should work because the above and below are in the same session id.
  sudo -u nobody /bin/sh -c "cat /cvmfs/$CVMFS_TEST_REPO/hello_world" > /dev/null || return $?
  sudo -u nobody setsid /bin/sh -c "cat /cvmfs/$CVMFS_TEST_REPO/hello_world" > /dev/null || return 0

  # Last line should have resulted in an IO error.
  return 1
}
