#!/bin/bash

cvmfs_test_name="Unpin catalogs on umount"
cvmfs_test_suites="quick"

cvmfs_run_test() {
  logfile=$1

  cvmfs_mount sft.cern.ch || return 1
  cvmfs_mount atlas.cern.ch || return 1

  ls /cvmfs/atlas.cern.ch/repo/ATLASLocalRootBase || return 2

  num_pinned=$(sudo cvmfs_talk -i sft.cern.ch cache list pinned | wc -l)

  cvmfs_umount atlas.cern.ch || return 4
  num_pinned2=$(sudo cvmfs_talk -i sft.cern.ch cache list pinned | wc -l)
  if [ $num_pinned -ne $(($num_pinned2 + 2)) ]; then
    echo "$num_pinned $num_pinned2"
    sudo cvmfs_talk -i sft.cern.ch cache list pinned
    return 5
  fi

  return 0
}
