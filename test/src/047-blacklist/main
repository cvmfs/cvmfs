
cvmfs_test_name="Certificate blacklist"

cleanup_blacklist() {
  sudo rm -f /etc/cvmfs/blacklist
}

cvmfs_run_test() {
  logfile=$1

  echo "mount grid.cern.ch"
  cvmfs_mount grid.cern.ch || return 1
  grep -q grid.cern.ch /proc/mounts || return 2

  trap cleanup_blacklist EXIT HUP INT TERM
  sudo touch /etc/cvmfs/blacklist

  echo "blacklist the grid.cern.ch fingerprint(s)"
  white="`curl -f -s http://cvmfs-stratum-one.cern.ch/cvmfs/grid.cern.ch/.cvmfswhitelist`" || return 10

  echo "$white" | cat -v | awk '/^N/{ok=1;next} /^--/{exit} ok==1 {print}'| \
    sed 's/ .*//' | sudo sh -c "tee /etc/cvmfs/blacklist"

  echo "force remount which should cause blacklisted repo to unmount"
  sudo cvmfs_talk -i grid.cern.ch remount
  sleep 2
  grep grid.cern.ch /proc/mounts && return 20

  echo "attempt another mount which should also fail"
  cvmfs_mount grid.cern.ch && return 21

  return 0
}
