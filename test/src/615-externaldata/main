
cvmfs_test_name="External data"
cvmfs_test_autofs_on_startup=false

verify_external_data() {
  local attr1=$(attr -qg external_file /var/spool/cvmfs/test.cern.ch/rdonly/external/file)
  local attr2=$(attr -qg external_file /var/spool/cvmfs/test.cern.ch/rdonly/internal/file)
  if [ "x$attr1" != "x1" ]; then
    echo "ERROR: External file /var/spool/cvmfs/test.cern.ch/rdonly/external/file not marked as external."
    return 20
  fi
  if [ "x$attr2" != "x0" ]; then
    echo "ERROR: Internal file /var/spool/cvmfs/test.cern.ch/rdonly/external/file not marked as internal."
    return 21
  fi
  local contents=$(cat /cvmfs/$CVMFS_TEST_REPO/external/file)
  if [ "x$contents" != "xHello World" ]; then
    return 22
  fi
  return 0
}

cvmfs_run_test() {
  logfile=$1
  local repo_dir=/cvmfs/$CVMFS_TEST_REPO

  echo "create a fresh repository named $CVMFS_TEST_REPO with user $CVMFS_TEST_USER"
  create_empty_repo $CVMFS_TEST_REPO $CVMFS_TEST_USER NO -X || return $?

  echo "create extended attributes"
  start_transaction $CVMFS_TEST_REPO || return $?
  mkdir -p /cvmfs/$CVMFS_TEST_REPO/external
  mkdir -p /cvmfs/$CVMFS_TEST_REPO/internal
  echo "Hello World" > /cvmfs/$CVMFS_TEST_REPO/external/file
  echo "external_data=0" > /cvmfs/$CVMFS_TEST_REPO/internal/.cvmfscatalog
  cp /cvmfs/$CVMFS_TEST_REPO/external/file /cvmfs/$CVMFS_TEST_REPO/internal/file

  echo "creating CVMFS snapshot"
  export CVMFS_LOG_LEVEL=4
  publish_repo $CVMFS_TEST_REPO -v || return $?

  local hash=$(attr -qg hash /var/spool/cvmfs/test.cern.ch/rdonly/internal/file)
  local cache_fname=$(echo $hash | cut -b 1-2)/$(echo $hash | cut -b 3-)
  local cache_file=/srv/cvmfs/$CVMFS_TEST_REPO/data/$cache_fname
  if [ ! -e "$cache_file" ]; then
    return 23
  fi
  mkdir -p /srv/cvmfs/$CVMFS_TEST_REPO/external
  mv "$cache_file" /srv/cvmfs/$CVMFS_TEST_REPO/external/file

  verify_external_data
  local verify_result=$?
  if [ $verify_result -ne 0 ]; then
    return $verify_result
  fi

  cp /srv/cvmfs/$CVMFS_TEST_REPO/external/file "$cache_file"

  echo "check catalog and data integrity"
  check_repository $CVMFS_TEST_REPO -i || return $?

  rm -f /srv/cvmfs/$CVMFS_TEST_REPO/external/file
  rm -f "$cache_file"
  rm -f /var/spool/cvmfs/test.cern.ch/cache/$CVMFS_TEST_REPO/$cache_fname

  cat /cvmfs/$CVMFS_TEST_REPO/external/file || return 0
  echo "External file /cvmfs/$CVMFS_TEST_REPO/external/file appears to be using internal data."
  return 24
}

